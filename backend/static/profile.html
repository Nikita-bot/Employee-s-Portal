<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мой профиль | Городская Больница</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/app/static/css/profile.css" type="text/css">
    <script src="/app/static/js/auth.js"></script>
</head>
<body>
    <div class="wrapper">
        <header>
            <div class="logo">Городская Больница</div>
            <div class="user-menu" onclick="toggleDropdown()">
                <span>Иванов Александр Сергеевич</span>
                <img src="https://i.imgur.com/3QZ9a7s.png" alt="Аватар">
                <div class="dropdown-menu" id="dropdownMenu">
                    <a href="/profile" class="dropdown-item">Мой профиль</a>
                    <button class="dropdown-item" onclick="showChangePasswordModal()">Сменить пароль</button>
                    <button class="dropdown-item" onclick="showTelegramModal()">Привязать Телеграмм</button>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" onclick="logout()">Выйти</button>
                </div>
            </div>
        </header>

        <div class="main-container">
            <sidebar>
                <ul class="nav-links">
                    <li><a href="/">
                        <i class="fas fa-home"></i>
                        <span>Главная</span>
                    </a></li>
                    <li><a href="/tasks">
                        <i class="fas fa-tasks"></i>
                        <span>Задачи</span>
                    </a></li>
                    <li><a href="#">
                        <i class="fas fa-file-alt"></i>
                        <span>ЭДО</span>
                    </a></li>
                    <li><a href="http://documents.kkbsmp.ru/view/list">
                        <i class="fas fa-book"></i>
                        <span>База знаний</span>
                    </a></li>
                    <li><a href="https://portals.kkbsmp.ru/">
                        <i class="fas fa-external-link-alt"></i>
                        <span>Порталы</span>
                    </a></li>
                    <li><a href="/news">
                        <i class="fas fa-newspaper"></i>
                        <span>Новости</span>
                    </a></li>
                    <li><a href="/support">
                        <i class="fas fa-headset"></i>
                        <span>Поддержка</span>
                    </a></li>
                </ul>
            </sidebar>

            <main class="content-area">
                <div class="page-header">
                    <h1>Мой профиль</h1>
                </div>

                <div class="profile-container">
                    <!-- Шапка профиля -->
                    <div class="profile-header">
                        <img src="https://i.imgur.com/3QZ9a7s.png" alt="Аватар" class="avatar-large">
                        <div class="profile-info">
                            <h2>Иванов Александр Сергеевич</h2>
                            <div class="profile-position">Врач-кардиолог высшей категории</div>
                            <div class="profile-department">Кардиологическое отделение</div>
                        </div>
                    </div>

                    <!-- Основная сетка -->
                    <div class="profile-grid">
                        <!-- Личная информация -->
                        <div class="info-section">
                            <div class="section-header">
                                <h3>Личная информация</h3>
                                <button class="edit-btn" onclick="editPersonalInfo()">Редактировать</button>
                            </div>
                            <div class="section-body">
                                <div class="info-item">
                                    <span class="info-label">Дата рождения:</span>
                                    <span class="info-value">15.03.1980</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Телефон:</span>
                                    <span class="info-value">+7 (912) 345-67-89</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Email:</span>
                                    <span class="info-value">a.ivanov@hospital.ru</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Кабинет:</span>
                                    <span class="info-value">305</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Стаж работы:</span>
                                    <span class="info-value">15 лет</span>
                                </div>
                            </div>
                        </div>

                        <!-- Профессиональная информация -->
                        <div class="info-section">
                            <div class="section-header">
                                <h3>Профессиональная информация</h3>
                                <button class="edit-btn" onclick="editProfessionalInfo()">Редактировать</button>
                            </div>
                            <div class="section-body">
                                <div class="info-item">
                                    <span class="info-label">Отдел:</span>
                                    <span class="info-value">Кардиология</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Должность:</span>
                                    <span class="info-value">Ведущий специалист</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Категория:</span>
                                    <span class="info-value">Высшая</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Ученая степень:</span>
                                    <span class="info-value">Кандидат медицинских наук</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Дата приема:</span>
                                    <span class="info-value">10.08.2008</span>
                                </div>
                            </div>
                        </div>

                        <!-- Статистика -->
                        <div class="info-section">
                            <div class="section-header">
                                <h3>Статистика за месяц</h3>
                            </div>
                            <div class="section-body">
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="stat-number">42</div>
                                        <div class="stat-label">Приемов</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number">18</div>
                                        <div class="stat-label">Операций</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number">96%</div>
                                        <div class="stat-label">Успешность</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ЭЦП и безопасность -->
                        <div class="info-section">
                            <div class="section-header">
                                <h3>ЭЦП и безопасность</h3>
                            </div>
                            <div class="section-body">
                                <div class="info-item">
                                    <span class="info-label">ЭЦП:</span>
                                    <span class="info-value">Активна до 15.12.2024</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Telegram:</span>
                                    <span class="info-value">Привязан</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Последний вход:</span>
                                    <span class="info-value">Сегодня, 10:30</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Двухфакторная аутентификация:</span>
                                    <span class="info-value">Включена</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Календарь -->
                    <div class="calendar-section">
                        <div class="section-header">
                            <h3>Календарь</h3>
                            <button class="edit-btn" onclick="showCalendar()">Просмотреть все</button>
                        </div>
                        <div class="calendar-header">
                            <span>Октябрь 2023</span>
                            <div>
                                <button class="btn btn-outline" style="padding: 0.25rem 0.5rem; margin-right: 0.5rem;">←</button>
                                <button class="btn btn-outline" style="padding: 0.25rem 0.5rem;">→</button>
                            </div>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Календарь будет генерироваться через JavaScript -->
                        </div>
                    </div>

                    <!-- Аналитика и быстрые действия -->
                    <div class="analytics-section">
                        <div class="section-header">
                            <h3>Аналитика и действия</h3>
                        </div>
                        <div class="analytics-grid">
                            <div class="chart-placeholder">
                                📊 График рабочей нагрузки<br>
                                <small>Здесь будет отображаться ваша активность и статистика</small>
                            </div>
                            <div class="quick-actions">
                                <a href="#" class="action-btn">
                                    <div class="action-icon">📋</div>
                                    <div class="action-text">
                                        <h4>Мои отчеты</h4>
                                        <p>Просмотр и создание отчетов</p>
                                    </div>
                                </a>
                                <a href="tasks.html" class="action-btn">
                                    <div class="action-icon">✅</div>
                                    <div class="action-text">
                                        <h4>Задачи</h4>
                                        <p>Текущие и назначенные</p>
                                    </div>
                                </a>
                                <a href="#" class="action-btn">
                                    <div class="action-icon">📚</div>
                                    <div class="action-text">
                                        <h4>База знаний</h4>
                                        <p>Протоколы и стандарты</p>
                                    </div>
                                </a>
                                <a href="support.html" class="action-btn">
                                    <div class="action-icon">🛠️</div>
                                    <div class="action-text">
                                        <h4>Поддержка</h4>
                                        <p>Техническая помощь</p>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Модальное окно редактирования личной информации -->
        <div class="modal" id="editPersonalModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Редактирование личной информации</h2>
                    <button class="close-btn" onclick="closeEditPersonalModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editPhone">Телефон</label>
                        <input type="tel" id="editPhone" value="+7 (912) 345-67-89">
                    </div>
                    <div class="form-group">
                        <label for="editEmail">Email</label>
                        <input type="email" id="editEmail" value="a.ivanov@hospital.ru">
                    </div>
                    <div class="form-group">
                        <label for="editCabinet">Кабинет</label>
                        <input type="text" id="editCabinet" value="305">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeEditPersonalModal()">Отмена</button>
                    <button class="btn btn-primary" onclick="savePersonalInfo()">Сохранить</button>
                </div>
            </div>
        </div>

        <!-- Модальное окно привязки Telegram -->
        <div class="modal" id="telegramModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>
                        Привязка Telegram
                    </h2>
                    <button class="close-btn" onclick="closeTelegramModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="instructions">
                        <h3>Как привязать Telegram:</h3>
                        
                        <div class="instruction-step">
                            <div class="step-number">1</div>
                            <div class="step-text">
                                Откройте Telegram и найдите бота <strong>@HospitalPortalBot</strong>
                            </div>
                        </div>
                        
                        <div class="instruction-step">
                            <div class="step-number">2</div>
                            <div class="step-text">
                                Отправьте боту команду <code>/start</code> для начала работы
                            </div>
                        </div>
                        
                        <div class="instruction-step">
                            <div class="step-number">3</div>
                            <div class="step-text">
                                Введите код подтверждения, который вам отправил бот
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="verificationCode">Код подтверждения</label>
                        <input type="text" id="verificationCode" class="code-input" placeholder="ABC123" maxlength="6" oninput="validateVerificationCode()">
                        <div class="error-message" id="codeError">Неверный код подтверждения</div>
                        <div class="success-message" id="codeSuccess">Код подтвержден!</div>
                    </div>

                    <div class="connection-info hidden" id="connectionInfo">
                        <img src="https://i.imgur.com/3QZ9a7s.png" alt="Аватар Telegram" class="user-avatar">
                        <div class="user-details">
                            <h4>Александр Иванов</h4>
                            <p>@alex_ivanov • Привязан 5 мин назад</p>
                        </div>
                    </div>

                    <div class="status-connected" id="statusConnected">
                        ✅ Telegram успешно привязан! Теперь вы будете получать уведомления о задачах и новостях.
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeTelegramModal()">Отмена</button>
                    <button class="btn btn-primary" id="connectBtn" onclick="connectTelegram()" disabled>Привязать</button>
                    <button class="btn btn-danger hidden" id="disconnectBtn" onclick="disconnectTelegram()">Отвязать</button>
                </div>
            </div>
        </div>

        <!-- Модальное окно смены пароля -->
        <div class="modal" id="changePasswordModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Смена пароля</h2>
                    <button class="close-btn" onclick="closeChangePasswordModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">

                        <div class="form-group">
                            <label for="newPassword">Новый пароль</label>
                            <div class="password-toggle">
                                <input type="password" id="newPassword" placeholder="Введите новый пароль" oninput="validatePassword()">
                                <button type="button" class="toggle-password" onclick="togglePasswordVisibility('newPassword')">👁️</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="confirmPassword">Подтверждение пароля</label>
                            <div class="password-toggle">
                                <input type="password" id="confirmPassword" placeholder="Повторите новый пароль" oninput="validatePassword()">
                                <button type="button" class="toggle-password" onclick="togglePasswordVisibility('confirmPassword')">👁️</button>
                            </div>
                            <div class="error-message" id="confirmPasswordError">Пароли не совпадают</div>
                        </div>

                        <div class="success-message" id="passwordSuccess">Пароль успешно изменен!</div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeChangePasswordModal()">Отмена</button>
                    <button class="btn btn-primary" id="savePasswordBtn" onclick="changePassword()" disabled>Сохранить</button>
                </div>
            </div>
        </div>

        <footer>
            <p>© 2023 Городская Больница. Корпоративная информационная система. Версия 2.1</p>
        </footer>
    </div>

    <script>
        // Функции для dropdown меню
        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('show');
        }

        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('dropdownMenu');
            const userMenu = document.querySelector('.user-menu');
            
            if (!userMenu.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Демо-функции для модальных окон
        function showChangePasswordModal() {
            alert('Переход к функции смены пароля');
        }

        function showTelegramModal() {
            alert('Переход к функции привязки Telegram');
        }

        function editPersonalInfo() {
            document.getElementById('editPersonalModal').classList.add('show');
        }

        function closeEditPersonalModal() {
            document.getElementById('editPersonalModal').classList.remove('show');
        }

        function editProfessionalInfo() {
            alert('Редактирование профессиональной информации');
        }

        function showCalendar() {
            alert('Открытие полного календаря');
        }

        function savePersonalInfo() {
            alert('Личная информация сохранена');
            closeEditPersonalModal();
        }

        // Генерация календаря
        function generateCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const daysOfWeek = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
            
            let calendarHTML = '';
            
            // Заголовки дней недели
            daysOfWeek.forEach(day => {
                calendarHTML += `<div class="calendar-day header">${day}</div>`;
            });
            
            // Демо-календарь (октябрь 2023)
            const daysInMonth = 31;
            const firstDay = 0; // 1 октября - воскресенье
            
            // Пустые дни перед началом месяца
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += `<div class="calendar-day other-month"></div>`;
            }
            
            // Дни месяца
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = day === 6; // 6 октября - сегодня
                let events = '';
                
                // Добавляем события для некоторых дней
                if (day === 6) {
                    events = '<div class="calendar-event">Прием 10:00</div>';
                } else if (day === 12) {
                    events = '<div class="calendar-event">Семинар 14:00</div>';
                } else if (day === 15) {
                    events = '<div class="calendar-event">Консилиум 11:00</div>';
                }
                
                calendarHTML += `
                    <div class="calendar-day ${isToday ? 'today' : ''}">
                        ${day}
                        ${events}
                    </div>
                `;
            }
            
            calendarGrid.innerHTML = calendarHTML;
        }

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            generateCalendar();
        });

        // Закрытие модальных окон при клике вне их
        document.addEventListener('click', function(event) {
            const editModal = document.getElementById('editPersonalModal');
            const telegramModal = document.getElementById('telegramModal');
            const passwordModal = document.getElementById('changePasswordModal');
            
            if (event.target === editModal) {
                closeEditPersonalModal();
            }
            if (event.target === telegramModal) {
                closeTelegramModal();
            }
            if (event.target === passwordModal) {
                closeChangePasswordModal();
            }
        });

        // Функции для модального окна Telegram
        function showTelegramModal() {
            document.getElementById('telegramModal').classList.add('show');
            document.getElementById('dropdownMenu').classList.remove('show');
            resetTelegramForm();
        }

        function closeTelegramModal() {
            document.getElementById('telegramModal').classList.remove('show');
        }

        function resetTelegramForm() {
            document.getElementById('verificationCode').value = '';
            document.getElementById('codeError').style.display = 'none';
            document.getElementById('codeSuccess').style.display = 'none';
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('statusConnected').classList.remove('show');
            document.getElementById('connectionInfo').classList.add('hidden');
            document.getElementById('disconnectBtn').classList.add('hidden');
            document.getElementById('connectBtn').classList.remove('hidden');
        }

        function validateVerificationCode() {
            const code = document.getElementById('verificationCode').value.toUpperCase();
            const connectBtn = document.getElementById('connectBtn');
            
            // Проверка формата кода (6 символов, буквы и цифры)
            const isValid = /^[A-Z0-9]{6}$/.test(code);
            
            connectBtn.disabled = !isValid;
            
            if (code.length === 6 && !isValid) {
                document.getElementById('codeError').style.display = 'block';
                document.getElementById('codeSuccess').style.display = 'none';
            } else if (isValid) {
                document.getElementById('codeError').style.display = 'none';
                document.getElementById('codeSuccess').style.display = 'block';
            } else {
                document.getElementById('codeError').style.display = 'none';
                document.getElementById('codeSuccess').style.display = 'none';
            }
        }

        function connectTelegram() {
            const code = document.getElementById('verificationCode').value.toUpperCase();
            
            // В реальном приложении здесь был бы AJAX запрос к серверу
            console.log('Привязка Telegram с кодом:', code);
            
            // Демо-логика для презентации
            if (code === 'ABC123') {
                // Успешная привязка
                document.getElementById('statusConnected').classList.add('show');
                document.getElementById('connectionInfo').classList.remove('hidden');
                document.getElementById('connectBtn').classList.add('hidden');
                document.getElementById('disconnectBtn').classList.remove('hidden');
                
                // Блокируем поле ввода
                document.getElementById('verificationCode').disabled = true;
            } else {
                // Ошибка привязки
                document.getElementById('codeError').style.display = 'block';
                document.getElementById('codeError').textContent = 'Неверный код подтверждения';
            }
        }

        function disconnectTelegram() {
            // В реальном приложении здесь был бы AJAX запрос к серверу
            console.log('Отвязка Telegram');
            
            // Сброс формы
            resetTelegramForm();
            document.getElementById('verificationCode').disabled = false;
            
            // Показываем сообщение об успешной отвязке
            alert('Telegram успешно отвязан от вашего аккаунта');
        }

        // Функции для модального окна смены пароля
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('show');
            document.getElementById('dropdownMenu').classList.remove('show');
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('show');
            resetPasswordForm();
        }

        function resetPasswordForm() {
            document.getElementById('changePasswordForm').reset();
            document.getElementById('confirmPasswordError').style.display = 'none';
            document.getElementById('passwordSuccess').style.display = 'none';
            document.getElementById('savePasswordBtn').disabled = true;
        }

        function togglePasswordVisibility(fieldId) {
            const field = document.getElementById(fieldId);
            const button = field.parentNode.querySelector('.toggle-password');
            
            if (field.type === 'password') {
                field.type = 'text';
                button.textContent = '🔒';
            } else {
                field.type = 'password';
                button.textContent = '👁️';
            }
        }

        function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // В реальном приложении здесь был бы AJAX запрос к серверу
            console.log('Смена пароля:', {
                newPassword: newPassword,
                confirmPassword: confirmPassword
            });
            
            document.getElementById('passwordSuccess').style.display = 'block';
            document.getElementById('savePasswordBtn').disabled = true;
                
            setTimeout(() => {
                closeChangePasswordModal();
            }, 2000);
        }

        function validatePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const saveBtn = document.getElementById('savePasswordBtn');
            const passwordsMatch = newPassword === confirmPassword && newPassword !== '';

            // Показ ошибки подтверждения пароля
            document.getElementById('confirmPasswordError').style.display = 
                confirmPassword && !passwordsMatch ? 'block' : 'none';
            
            saveBtn.disabled = !(passwordsMatch);
        }

        // Обработка Enter в форме
        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && document.getElementById('telegramModal').classList.contains('show')) {
                const connectBtn = document.getElementById('connectBtn');
                if (!connectBtn.disabled) {
                    connectTelegram();
                }
            }
        });
    </script>
</body>
</html>