<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Задачи | Городская Больница</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/app/static/css/task.css">
    <script src="/app/static/js/auth.js"></script>
</head>
<body>
    <div class="wrapper">
        <header>
            <div class="logo">Городская Больница</div>
            <div class="user-menu" onclick="toggleDropdown()">
                <span>Иванов Александр Сергеевич</span>
                <img src="https://i.imgur.com/3QZ9a7s.png" alt="Аватар">
                <div class="dropdown-menu" id="dropdownMenu">
                    <a href="/profile" class="dropdown-item">Мой профиль</a>
                    <button class="dropdown-item" onclick="showChangePasswordModal()">Сменить пароль</button>
                    <button class="dropdown-item" onclick="showTelegramModal()">Привязать Телеграмм</button>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" onclick="logout()">Выйти</button>
                </div>
            </div>
        </header>

        <div class="main-container">
            <sidebar>
                <ul class="nav-links">
                    <li><a href="/">
                        <i class="fas fa-home"></i>
                        <span>Главная</span>
                    </a></li>
                    <li><a href="/tasks" class="active">
                        <i class="fas fa-tasks"></i>
                        <span>Задачи</span>
                    </a></li>
                    <li><a href="#">
                        <i class="fas fa-file-alt"></i>
                        <span>ЭДО</span>
                    </a></li>
                    <li><a href="http://documents.kkbsmp.ru/view/list">
                        <i class="fas fa-book"></i>
                        <span>База знаний</span>
                    </a></li>
                    <li><a href="https://portals.kkbsmp.ru/">
                        <i class="fas fa-external-link-alt"></i>
                        <span>Порталы</span>
                    </a></li>
                    <li><a href="/news">
                        <i class="fas fa-newspaper"></i>
                        <span>Новости</span>
                    </a></li>
                    <li><a href="/support">
                        <i class="fas fa-headset"></i>
                        <span>Поддержка</span>
                    </a></li>
                </ul>
            </sidebar>

            <main class="content-area">
                <div class="page-header">
                    <div>
                        <h1>Задачи</h1>
                        <div class="task-count" id="taskCount">Всего задач: 8</div>
                    </div>
                </div>

                <div class="task-controls">
                    <button class="btn btn-primary" onclick="showCreateTaskModal()">Создать задачу</button>
                    <select class="filter-select" onchange="filterTasks(this.value)">
                        <option value="all">Все задачи</option>
                        <option value="active">Не выполненные</option>
                        <option value="completed">Выполненные</option>
                    </select>
                    <div class="view-toggle">
                        <button class="view-toggle-btn active" onclick="switchView('assigned-to-me')">Назначенные мне</button>
                        <button class="view-toggle-btn" onclick="switchView('assigned-by-me')">Назначенные мной</button>
                    </div>
                </div>

                <div class="tasks-grid" id="tasksGrid">
                    <!-- Задачи будут добавляться через JavaScript -->
                </div>
            </main>
        </div>

        <!-- Модальное окно создания задачи -->
        <div class="modal" id="createTaskModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Создание новой задачи</h2>
                    <button class="close-btn" onclick="closeCreateTaskModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="taskType">Тип задачи</label>
                        <select id="taskType">
                            <option value="medical">Медицинская задача</option>
                            <option value="administrative">Административная</option>
                            <option value="technical">Техническая</option>
                            <option value="other">Другая</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="taskDescription">Описание</label>
                        <textarea id="taskDescription" placeholder="Подробное описание задачи"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="taskPriority">Приоритет</label>
                        <select id="taskPriority">
                            <option value="low">Низкий</option>
                            <option value="medium">Средний</option>
                            <option value="high">Высокий</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeCreateTaskModal()">Отмена</button>
                    <button class="btn btn-primary" onclick="createNewTask()">Создать задачу</button>
                </div>
            </div>
        </div>

        <!-- Модальное окно просмотра задачи -->
        <div class="modal" id="viewTaskModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="viewTaskTitle">Просмотр задачи</h2>
                    <button class="close-btn" onclick="closeViewTaskModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Создатель</label>
                        <div id="viewTaskCreator"></div>
                    </div>
                    <div class="form-group">
                        <label>Исполнитель</label>
                        <select id="viewTaskAssignee">
                            <option value="petrov">Петров М.И. (Хирург)</option>
                            <option value="sidorova">Сидорова А.В. (Медсестра)</option>
                            <option value="kozlov">Козлов Д.С. (Администратор)</option>
                            <option value="ivanov">Иванов А.С. (Кардиолог)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Приоритет</label>
                        <div id="viewTaskPriority"></div>
                    </div>
                    <div class="form-group">
                        <label>Статус</label>
                        <select id="viewTaskStatus" onchange="updateTaskStatus(this.value)">
                            <option value="created">Создана</option>
                            <option value="in-progress">В работе</option>
                            <option value="completed">Выполнена</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Описание</label>
                        <div id="viewTaskDescription"></div>
                    </div>
                    
                    <div class="comments-section">
                        <h3>Комментарии</h3>
                        <div id="taskComments">
                            <!-- Комментарии будут добавляться здесь -->
                        </div>
                        <div class="comment-input">
                            <input type="text" id="newComment" placeholder="Введите комментарий...">
                            <button class="btn btn-primary" onclick="addComment()">Отправить</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="closeViewTaskModal()">Закрыть</button>
                </div>
            </div>
        </div>

        <!-- Модальное окно привязки Telegram -->
        <div class="modal" id="telegramModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>
                        Привязка Telegram
                    </h2>
                    <button class="close-btn" onclick="closeTelegramModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="instructions">
                        <h3>Как привязать Telegram:</h3>
                        
                        <div class="instruction-step">
                            <div class="step-number">1</div>
                            <div class="step-text">
                                Откройте Telegram и найдите бота <strong>@HospitalPortalBot</strong>
                            </div>
                        </div>
                        
                        <div class="instruction-step">
                            <div class="step-number">2</div>
                            <div class="step-text">
                                Отправьте боту команду <code>/start</code> для начала работы
                            </div>
                        </div>
                        
                        <div class="instruction-step">
                            <div class="step-number">3</div>
                            <div class="step-text">
                                Введите код подтверждения, который вам отправил бот
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="verificationCode">Код подтверждения</label>
                        <input type="text" id="verificationCode" class="code-input" placeholder="ABC123" maxlength="6" oninput="validateVerificationCode()">
                        <div class="error-message" id="codeError">Неверный код подтверждения</div>
                        <div class="success-message" id="codeSuccess">Код подтвержден!</div>
                    </div>

                    <div class="connection-info hidden" id="connectionInfo">
                        <img src="https://i.imgur.com/3QZ9a7s.png" alt="Аватар Telegram" class="user-avatar">
                        <div class="user-details">
                            <h4>Александр Иванов</h4>
                            <p>@alex_ivanov • Привязан 5 мин назад</p>
                        </div>
                    </div>

                    <div class="status-connected" id="statusConnected">
                        ✅ Telegram успешно привязан! Теперь вы будете получать уведомления о задачах и новостях.
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeTelegramModal()">Отмена</button>
                    <button class="btn btn-primary" id="connectBtn" onclick="connectTelegram()" disabled>Привязать</button>
                    <button class="btn btn-danger hidden" id="disconnectBtn" onclick="disconnectTelegram()">Отвязать</button>
                </div>
            </div>
        </div>

        <!-- Модальное окно смены пароля -->
        <div class="modal" id="changePasswordModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Смена пароля</h2>
                    <button class="close-btn" onclick="closeChangePasswordModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">

                        <div class="form-group">
                            <label for="newPassword">Новый пароль</label>
                            <div class="password-toggle">
                                <input type="password" id="newPassword" placeholder="Введите новый пароль" oninput="validatePassword()">
                                <button type="button" class="toggle-password" onclick="togglePasswordVisibility('newPassword')">👁️</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="confirmPassword">Подтверждение пароля</label>
                            <div class="password-toggle">
                                <input type="password" id="confirmPassword" placeholder="Повторите новый пароль" oninput="validatePassword()">
                                <button type="button" class="toggle-password" onclick="togglePasswordVisibility('confirmPassword')">👁️</button>
                            </div>
                            <div class="error-message" id="confirmPasswordError">Пароли не совпадают</div>
                        </div>

                        <div class="success-message" id="passwordSuccess">Пароль успешно изменен!</div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeChangePasswordModal()">Отмена</button>
                    <button class="btn btn-primary" id="savePasswordBtn" onclick="changePassword()" disabled>Сохранить</button>
                </div>
            </div>
        </div>

        <footer>
            <p>© 2023 Городская Больница. Корпоративная информационная система. Версия 2.1</p>
        </footer>
    </div>

    <script>
        // Данные задач (в реальном приложении будут приходить с сервера)
        let tasks = [
            {
                id: 1,
                title: "Консилиум по пациенту Петров И.В.",
                description: "Обсуждение результатов МРТ и плана лечения. Присутствие обязательно.",
                priority: "high",
                status: "created",
                creator: "Главный врач",
                assignee: "Иванов А.С.",
                type: "medical",
                comments: [
                    { author: "Главный врач", text: "Подготовьте заключение до встречи", time: "05.10.2023 10:00" }
                ]
            },
            {
                id: 2,
                title: "Заполнение медицинской документации",
                description: "Завершить ведение истории болезней за октябрь",
                priority: "medium",
                status: "in-progress",
                creator: "Иванов А.С.",
                assignee: "Сидорова А.В.",
                type: "administrative",
                comments: []
            },
            {
                id: 3,
                title: "Плановый осмотр пациентов",
                description: "Ежедневный обход пациентов кардиологического отделения",
                priority: "low",
                status: "completed",
                creator: "Администрация",
                assignee: "Иванов А.С.",
                type: "medical",
                comments: [
                    { author: "Иванов А.С.", text: "Осмотр завершен, все пациенты стабильны", time: "06.10.2023 09:30" }
                ]
            }
        ];

        let currentView = 'assigned-to-me';
        let currentTaskId = null;

        // Функции для dropdown меню
        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('show');
        }

        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('dropdownMenu');
            const userMenu = document.querySelector('.user-menu');
            
            if (!userMenu.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Инициализация страницы
        document.addEventListener('DOMContentLoaded', function() {
            renderTasks();
        });

        // Рендер задач
        function renderTasks() {
            const tasksGrid = document.getElementById('tasksGrid');
            const filteredTasks = filterTasksByView(tasks);
            
            tasksGrid.innerHTML = '';
            
            filteredTasks.forEach(task => {
                const taskElement = createTaskElement(task);
                tasksGrid.appendChild(taskElement);
            });
            
            updateTaskCount();
        }

        function filterTasksByView(tasksList) {
            if (currentView === 'assigned-to-me') {
                return tasksList.filter(task => task.assignee === 'Иванов А.С.');
            } else {
                return tasksList.filter(task => task.creator === 'Иванов А.С.');
            }
        }

        function createTaskElement(task) {
            const taskDiv = document.createElement('div');
            taskDiv.className = `task-item ${task.priority}-priority ${task.status === 'completed' ? 'completed' : ''}`;
            taskDiv.onclick = () => openViewTaskModal(task.id);
            
            const statusText = {
                'created': 'Создана',
                'in-progress': 'В работе', 
                'completed': 'Выполнена'
            };
            
            const priorityText = {
                'high': 'Высокий',
                'medium': 'Средний',
                'low': 'Низкий'
            };

            taskDiv.innerHTML = `
                <div class="task-header">
                    <div>
                        <div class="task-title">${task.title}</div>
                        <div class="task-description">${task.description}</div>
                    </div>
                    <span class="task-priority priority-${task.priority}">${priorityText[task.priority]}</span>
                </div>
                <div class="task-meta">
                    <span>${currentView === 'assigned-to-me' ? 'Создатель: ' + task.creator : 'Исполнитель: ' + task.assignee}</span>
                    <span class="task-status status-${task.status}">${statusText[task.status]}</span>
                </div>
            `;
            
            return taskDiv;
        }

        function updateTaskCount() {
            const filteredTasks = filterTasksByView(tasks);
            document.getElementById('taskCount').textContent = `Всего задач: ${filtergedTasks.length}`;
        }

        // Переключение между видами
        function switchView(view) {
            currentView = view;
            const buttons = document.querySelectorAll('.view-toggle-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderTasks();
        }

        // Фильтрация задач
        function filterTasks(filter) {
            // В реальном приложении здесь была бы фильтрация через AJAX
            console.log('Фильтр:', filter);
            renderTasks();
        }

        // Модальные окна
        function showCreateTaskModal() {
            document.getElementById('createTaskModal').classList.add('show');
        }

        function closeCreateTaskModal() {
            document.getElementById('createTaskModal').classList.remove('show');
        }

        function openViewTaskModal(taskId) {
            currentTaskId = taskId;
            const task = tasks.find(t => t.id === taskId);
            
            if (task) {
                document.getElementById('viewTaskTitle').textContent = task.title;
                document.getElementById('viewTaskCreator').textContent = task.creator;
                document.getElementById('viewTaskAssignee').value = getAssigneeValue(task.assignee);
                document.getElementById('viewTaskPriority').textContent = getPriorityText(task.priority);
                document.getElementById('viewTaskStatus').value = task.status;
                document.getElementById('viewTaskDescription').textContent = task.description;
                
                renderComments(task.comments);
            }
            
            document.getElementById('viewTaskModal').classList.add('show');
        }

        function closeViewTaskModal() {
            document.getElementById('viewTaskModal').classList.remove('show');
        }

        function getAssigneeValue(assignee) {
            const mapping = {
                'Иванов А.С.': 'ivanov',
                'Петров М.И.': 'petrov', 
                'Сидорова А.В.': 'sidorova',
                'Козлов Д.С.': 'kozlov'
            };
            return mapping[assignee] || 'ivanov';
        }

        function getPriorityText(priority) {
            const texts = {
                'high': 'Высокий',
                'medium': 'Средний',
                'low': 'Низкий'
            };
            return texts[priority];
        }

        function renderComments(comments) {
            const commentsContainer = document.getElementById('taskComments');
            commentsContainer.innerHTML = '';
            
            comments.forEach(comment => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment';
                commentDiv.innerHTML = `
                    <div class="comment-header">
                        <span class="comment-author">${comment.author}</span>
                        <span class="comment-time">${comment.time}</span>
                    </div>
                    <div class="comment-text">${comment.text}</div>
                `;
                commentsContainer.appendChild(commentDiv);
            });
        }

        function addComment() {
            const commentInput = document.getElementById('newComment');
            const commentText = commentInput.value.trim();
            
            if (commentText && currentTaskId) {
                const task = tasks.find(t => t.id === currentTaskId);
                if (task) {
                    const newComment = {
                        author: 'Иванов А.С.',
                        text: commentText,
                        time: new Date().toLocaleString('ru-RU')
                    };
                    task.comments.push(newComment);
                    renderComments(task.comments);
                    commentInput.value = '';
                }
            }
        }

        function updateTaskStatus(status) {
            if (currentTaskId) {
                const task = tasks.find(t => t.id === currentTaskId);
                if (task) {
                    task.status = status;
                    renderTasks();
                }
            }
        }

        function createNewTask() {
            const description = document.getElementById('taskDescription').value;
            const type = document.getElementById('taskType').value;
            const priority = document.getElementById('taskPriority').value;
            
            if (title && description) {
                const newTask = {
                    id: tasks.length + 1,
                    title: title,
                    description: description,
                    type: type,
                    priority: priority,
                    status: 'created',
                    creator: 'Иванов А.С.',
                    assignee: getAssigneeName(assignee),
                    comments: []
                };
                
                tasks.push(newTask);
                closeCreateTaskModal();
                renderTasks();
                
                // Сброс формы
                document.getElementById('taskDescription').value = '';
            }
        }

        function getAssigneeName(assigneeValue) {
            const mapping = {
                'petrov': 'Петров М.И.',
                'sidorova': 'Сидорова А.В.',
                'kozlov': 'Козлов Д.С.'
            };
            return mapping[assigneeValue] || 'Петров М.И.';
        }

        // Функции для модального окна Telegram
        function showTelegramModal() {
            document.getElementById('telegramModal').classList.add('show');
            document.getElementById('dropdownMenu').classList.remove('show');
            resetTelegramForm();
        }

        function closeTelegramModal() {
            document.getElementById('telegramModal').classList.remove('show');
        }

        function resetTelegramForm() {
            document.getElementById('verificationCode').value = '';
            document.getElementById('codeError').style.display = 'none';
            document.getElementById('codeSuccess').style.display = 'none';
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('statusConnected').classList.remove('show');
            document.getElementById('connectionInfo').classList.add('hidden');
            document.getElementById('disconnectBtn').classList.add('hidden');
            document.getElementById('connectBtn').classList.remove('hidden');
        }

        function validateVerificationCode() {
            const code = document.getElementById('verificationCode').value.toUpperCase();
            const connectBtn = document.getElementById('connectBtn');
            
            // Проверка формата кода (6 символов, буквы и цифры)
            const isValid = /^[A-Z0-9]{6}$/.test(code);
            
            connectBtn.disabled = !isValid;
            
            if (code.length === 6 && !isValid) {
                document.getElementById('codeError').style.display = 'block';
                document.getElementById('codeSuccess').style.display = 'none';
            } else if (isValid) {
                document.getElementById('codeError').style.display = 'none';
                document.getElementById('codeSuccess').style.display = 'block';
            } else {
                document.getElementById('codeError').style.display = 'none';
                document.getElementById('codeSuccess').style.display = 'none';
            }
        }

        function connectTelegram() {
            const code = document.getElementById('verificationCode').value.toUpperCase();
            
            // В реальном приложении здесь был бы AJAX запрос к серверу
            console.log('Привязка Telegram с кодом:', code);
            
            // Демо-логика для презентации
            if (code === 'ABC123') {
                // Успешная привязка
                document.getElementById('statusConnected').classList.add('show');
                document.getElementById('connectionInfo').classList.remove('hidden');
                document.getElementById('connectBtn').classList.add('hidden');
                document.getElementById('disconnectBtn').classList.remove('hidden');
                
                // Блокируем поле ввода
                document.getElementById('verificationCode').disabled = true;
            } else {
                // Ошибка привязки
                document.getElementById('codeError').style.display = 'block';
                document.getElementById('codeError').textContent = 'Неверный код подтверждения';
            }
        }

        function disconnectTelegram() {
            // В реальном приложении здесь был бы AJAX запрос к серверу
            console.log('Отвязка Telegram');
            
            // Сброс формы
            resetTelegramForm();
            document.getElementById('verificationCode').disabled = false;
            
            // Показываем сообщение об успешной отвязке
            alert('Telegram успешно отвязан от вашего аккаунта');
        }

        // Функции для модального окна смены пароля
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('show');
            document.getElementById('dropdownMenu').classList.remove('show');
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('show');
            resetPasswordForm();
        }

        function resetPasswordForm() {
            document.getElementById('changePasswordForm').reset();
            document.getElementById('confirmPasswordError').style.display = 'none';
            document.getElementById('passwordSuccess').style.display = 'none';
            document.getElementById('savePasswordBtn').disabled = true;
        }

        function togglePasswordVisibility(fieldId) {
            const field = document.getElementById(fieldId);
            const button = field.parentNode.querySelector('.toggle-password');
            
            if (field.type === 'password') {
                field.type = 'text';
                button.textContent = '🔒';
            } else {
                field.type = 'password';
                button.textContent = '👁️';
            }
        }

        function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // В реальном приложении здесь был бы AJAX запрос к серверу
            console.log('Смена пароля:', {
                newPassword: newPassword,
                confirmPassword: confirmPassword
            });
            
            document.getElementById('passwordSuccess').style.display = 'block';
            document.getElementById('savePasswordBtn').disabled = true;
                
            setTimeout(() => {
                closeChangePasswordModal();
            }, 2000);
        }

        function validatePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const saveBtn = document.getElementById('savePasswordBtn');
            const passwordsMatch = newPassword === confirmPassword && newPassword !== '';

            // Показ ошибки подтверждения пароля
            document.getElementById('confirmPasswordError').style.display = 
                confirmPassword && !passwordsMatch ? 'block' : 'none';
            
            saveBtn.disabled = !(passwordsMatch);
        }

        // Закрытие модальных окон при клике вне их
        document.addEventListener('click', function(event) {
            const telegramModal = document.getElementById('telegramModal');
            const passwordModal = document.getElementById('changePasswordModal');
            
            if (event.target === telegramModal) {
                closeTelegramModal();
            }
            if (event.target === passwordModal) {
                closeChangePasswordModal();
            }
        });

        // Обработка Enter в форме
        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && document.getElementById('telegramModal').classList.contains('show')) {
                const connectBtn = document.getElementById('connectBtn');
                if (!connectBtn.disabled) {
                    connectTelegram();
                }
            }
        });
    </script>
</body>
</html>