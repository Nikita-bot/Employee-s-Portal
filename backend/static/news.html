<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Новости | Городская Больница</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/app/static/css/news.css" type="text/css">
    <script src="/app/static/js/auth.js"></script>
</head>
<body>
    <div class="wrapper">
        <header>
            <div class="logo">Городская Больница</div>
            <div class="user-menu" onclick="toggleDropdown()">
                <span>Иванов Александр Сергеевич</span>
                <img src="https://i.imgur.com/3QZ9a7s.png" alt="Аватар">
                <div class="dropdown-menu" id="dropdownMenu">
                    <a href="/profile" class="dropdown-item">Мой профиль</a>
                    <button class="dropdown-item" onclick="showChangePasswordModal()">Сменить пароль</button>
                    <button class="dropdown-item" onclick="showTelegramModal()">Привязать Телеграмм</button>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" onclick="logout()">Выйти</button>
                </div>
            </div>
        </header>

        <div class="main-container">
            <sidebar>
                <ul class="nav-links">
                    <li><a href="/">
                        <i class="fas fa-home"></i>
                        <span>Главная</span>
                    </a></li>
                    <li><a href="/tasks">
                        <i class="fas fa-tasks"></i>
                        <span>Задачи</span>
                    </a></li>
                    <li><a href="#">
                        <i class="fas fa-file-alt"></i>
                        <span>ЭДО</span>
                    </a></li>
                    <li><a href="http://documents.kkbsmp.ru/view/list">
                        <i class="fas fa-book"></i>
                        <span>База знаний</span>
                    </a></li>
                    <li><a href="https://portals.kkbsmp.ru/">
                        <i class="fas fa-external-link-alt"></i>
                        <span>Порталы</span>
                    </a></li>
                    <li><a href="/news" class="active">
                        <i class="fas fa-newspaper"></i>
                        <span>Новости</span>
                    </a></li>
                    <li><a href="/support">
                        <i class="fas fa-headset"></i>
                        <span>Поддержка</span>
                    </a></li>
                </ul>
            </sidebar>

            <main class="content-area">
                <div class="page-header">
                    <h1>Новости и объявления</h1>
                </div>

                <div class="news-controls">
                    <button class="btn btn-primary" onclick="showCreateNewsModal()">Создать новость</button>
                    <input type="text" class="search-box" placeholder="Поиск по новостям..." onkeyup="searchNews(this.value)">
                    <select class="filter-select" onchange="filterNewsByType(this.value)">
                        <option value="all">Все новости</option>
                        <option value="announcement">Объявления</option>
                        <option value="event">События</option>
                        <option value="medical">Медицинские</option>
                        <option value="technical">Технические</option>
                    </select>
                    <select class="filter-select" onchange="filterNewsByDate(this.value)">
                        <option value="all">За все время</option>
                        <option value="today">Сегодня</option>
                        <option value="week">За неделю</option>
                        <option value="month">За месяц</option>
                    </select>
                </div>

                <div class="news-grid" id="newsGrid">
                    <!-- Новости будут добавляться через JavaScript -->
                </div>

                <div class="pagination">
                    <button class="page-btn active">1</button>
                    <button class="page-btn">2</button>
                    <button class="page-btn">3</button>
                    <button class="page-btn">→</button>
                </div>
            </main>
        </div>

        <!-- Модальное окно создания новости -->
        <div class="modal" id="createNewsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Создание новости</h2>
                    <button class="close-btn" onclick="closeCreateNewsModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="newsTitle">Заголовок новости</label>
                        <input type="text" id="newsTitle" placeholder="Введите заголовок">
                    </div>
                    <div class="form-group">
                        <label for="newsCategory">Категория</label>
                        <select id="newsCategory">
                            <option value="announcement">Объявление</option>
                            <option value="event">Событие</option>
                            <option value="medical">Медицинская</option>
                            <option value="technical">Техническая</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newsContent">Содержание новости</label>
                        <textarea id="newsContent" placeholder="Подробное содержание новости..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeCreateNewsModal()">Отмена</button>
                    <button class="btn btn-primary" onclick="createNewNews()">Опубликовать</button>
                </div>
            </div>
        </div>

        <!-- Модальное окно просмотра новости -->
        <div class="modal" id="newsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalNewsTitle">Заголовок новости</h2>
                    <button class="close-btn" onclick="closeNewsModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="full-news-meta">
                        <span id="modalNewsDate">Дата</span>
                        <span id="modalNewsCategory">Категория</span>
                        <span id="modalNewsAuthor">Автор</span>
                    </div>
                    <div class="full-news-content" id="modalNewsContent">
                        <!-- Полный текст новости -->
                    </div>
                    <div class="news-attachments" id="modalNewsAttachments">
                        <!-- Вложения -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Модальное окно привязки Telegram -->
        <div class="modal" id="telegramModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>
                        Привязка Telegram
                    </h2>
                    <button class="close-btn" onclick="closeTelegramModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="instructions">
                        <h3>Как привязать Telegram:</h3>
                        
                        <div class="instruction-step">
                            <div class="step-number">1</div>
                            <div class="step-text">
                                Откройте Telegram и найдите бота <strong>@HospitalPortalBot</strong>
                            </div>
                        </div>
                        
                        <div class="instruction-step">
                            <div class="step-number">2</div>
                            <div class="step-text">
                                Отправьте боту команду <code>/start</code> для начала работы
                            </div>
                        </div>
                        
                        <div class="instruction-step">
                            <div class="step-number">3</div>
                            <div class="step-text">
                                Введите код подтверждения, который вам отправил бот
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="verificationCode">Код подтверждения</label>
                        <input type="text" id="verificationCode" class="code-input" placeholder="ABC123" maxlength="6" oninput="validateVerificationCode()">
                        <div class="error-message" id="codeError">Неверный код подтверждения</div>
                        <div class="success-message" id="codeSuccess">Код подтвержден!</div>
                    </div>

                    <div class="connection-info hidden" id="connectionInfo">
                        <img src="https://i.imgur.com/3QZ9a7s.png" alt="Аватар Telegram" class="user-avatar">
                        <div class="user-details">
                            <h4>Александр Иванов</h4>
                            <p>@alex_ivanov • Привязан 5 мин назад</p>
                        </div>
                    </div>

                    <div class="status-connected" id="statusConnected">
                        ✅ Telegram успешно привязан! Теперь вы будете получать уведомления о задачах и новостях.
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeTelegramModal()">Отмена</button>
                    <button class="btn btn-primary" id="connectBtn" onclick="connectTelegram()" disabled>Привязать</button>
                    <button class="btn btn-danger hidden" id="disconnectBtn" onclick="disconnectTelegram()">Отвязать</button>
                </div>
            </div>
        </div>

        <!-- Модальное окно смены пароля -->
        <div class="modal" id="changePasswordModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Смена пароля</h2>
                    <button class="close-btn" onclick="closeChangePasswordModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">

                        <div class="form-group">
                            <label for="newPassword">Новый пароль</label>
                            <div class="password-toggle">
                                <input type="password" id="newPassword" placeholder="Введите новый пароль" oninput="validatePassword()">
                                <button type="button" class="toggle-password" onclick="togglePasswordVisibility('newPassword')">👁️</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="confirmPassword">Подтверждение пароля</label>
                            <div class="password-toggle">
                                <input type="password" id="confirmPassword" placeholder="Повторите новый пароль" oninput="validatePassword()">
                                <button type="button" class="toggle-password" onclick="togglePasswordVisibility('confirmPassword')">👁️</button>
                            </div>
                            <div class="error-message" id="confirmPasswordError">Пароли не совпадают</div>
                        </div>

                        <div class="success-message" id="passwordSuccess">Пароль успешно изменен!</div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeChangePasswordModal()">Отмена</button>
                    <button class="btn btn-primary" id="savePasswordBtn" onclick="changePassword()" disabled>Сохранить</button>
                </div>
            </div>
        </div>

        <footer>
            <p>© 2023 Городская Больница. Корпоративная информационная система. Версия 2.1</p>
        </footer>
    </div>

    <script>
        // Данные новостей
        let newsData = [
            {
                id: 1,
                title: "Обновление регламента электронного документооборота",
                preview: "С 15 октября вводится новый порядок подписания медицинских документов...",
                content: `<p>С 15 октября 2023 года в нашей больнице вводится новый порядок подписания медицинских документов с использованием усиленной электронной подписи.</p>
                         <h3>Основные изменения:</h3>
                         <p>Все медицинские документы должны быть подписаны в течение 24 часов с момента создания. Внедряется двухэтапная система проверки для особо важных случаев.</p>
                         <h3>Обучение:</h3>
                         <p>Обязательные обучающие семинары для всех сотрудников пройдут с 10 по 12 октября в конференц-зале главного корпуса.</p>`,
                date: "05.10.2023",
                category: "announcement",
                author: "Администрация",
                important: true,
                attachments: [
                    { name: "Новый регламент.pdf", type: "pdf" },
                    { name: "График обучения.xlsx", type: "excel" }
                ]
            },
            {
                id: 2,
                title: "Плановые технические работы 15 октября",
                preview: "15 октября с 22:00 до 02:00 будут проводиться технические работы...",
                content: `<p>Уважаемые сотрудники! Сообщаем вам о проведении плановых технических работ.</p>
                         <p><strong>Дата и время:</strong> 15 октября 2023 года с 22:00 до 02:00</p>
                         <p><strong>Что будет обновлено:</strong></p>
                         <ul>
                             <li>Система электронного документооборота</li>
                             <li>База данных пациентов</li>
                             <li>Резервное копирование</li>
                         </ul>
                         <p>В указанное время корпоративный портал и смежные системы будут недоступны. Пожалуйста, спланируйте свою работу accordingly.</p>`,
                date: "03.10.2023",
                category: "technical",
                author: "IT-отдел",
                important: true,
                attachments: []
            },
            {
                id: 3,
                title: "Семинар по новым медицинским стандартам в кардиологии",
                preview: "Приглашаем всех врачей-кардиологов на семинар 12 октября в 14:00...",
                content: `<p>Приглашаем всех врачей-кардиологов и заинтересованных специалистов на научно-практический семинар.</p>
                         <p><strong>Тема:</strong> "Современные подходы к диагностике и лечению сердечно-сосудистых заболеваний"</p>
                         <p><strong>Дата и время:</strong> 12 октября 2023 года, 14:00</p>
                         <p><strong>Место:</strong> Конференц-зал главного корпуса</p>
                         <p><strong>Спикеры:</strong></p>
                         <ul>
                             <li>Проф. Иванов А.С. - "Инновации в кардиохирургии"</li>
                             <li>Доц. Петрова М.И. - "Новые протоколы медикаментозной терапии"</li>
                             <li>К.м.н. Сидоров В.П. - "Реабилитация кардиологических пациентов"</li>
                         </ul>`,
                date: "01.10.2023",
                category: "medical",
                author: "Научный отдел",
                important: false,
                attachments: [
                    { name: "Программа семинара.pdf", type: "pdf" }
                ]
            }
        ];

        let currentFilter = 'all';

        // Функции для dropdown меню
        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('show');
        }

        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('dropdownMenu');
            const userMenu = document.querySelector('.user-menu');
            
            if (!userMenu.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Инициализация страницы
        document.addEventListener('DOMContentLoaded', function() {
            renderNews();
        });

        // Рендер новостей
        function renderNews() {
            const newsGrid = document.getElementById('newsGrid');
            const filteredNews = filterNews(newsData);
            
            newsGrid.innerHTML = '';
            
            filteredNews.forEach(news => {
                const newsElement = createNewsElement(news);
                newsGrid.appendChild(newsElement);
            });
        }

        function filterNews(newsList) {
            let filtered = newsList;
            
            // Фильтрация по типу
            if (currentFilter !== 'all') {
                filtered = filtered.filter(news => news.category === currentFilter);
            }
            
            return filtered;
        }

        function createNewsElement(news) {
            const newsDiv = document.createElement('div');
            newsDiv.className = `news-card ${news.important ? 'featured' : ''}`;
            
            const categoryText = {
                'announcement': 'Объявление',
                'event': 'Событие', 
                'medical': 'Медицинское',
                'technical': 'Техническое'
            };

            const categoryClass = {
                'announcement': 'category-announcement',
                'event': 'category-event',
                'medical': 'category-medical', 
                'technical': 'category-technical'
            };

            newsDiv.innerHTML = `
                <div class="news-card-header">
                    <div class="news-meta">
                        <span class="news-date">${news.date}</span>
                        <span class="news-category ${categoryClass[news.category]}">${categoryText[news.category]}</span>
                    </div>
                    <div class="news-title">${news.title}</div>
                    <div class="news-preview">${news.preview}</div>
                </div>
                <div class="news-card-body">
                    <div class="news-content">${news.content.substring(0, 150)}...</div>
                    ${news.attachments.length > 0 ? `
                        <div class="news-attachments">
                            ${news.attachments.map(att => 
                                `<a href="#" class="attachment">📎 ${att.name}</a>`
                            ).join('')}
                        </div>
                    ` : ''}
                </div>
                <div class="news-card-footer">
                    <span class="news-author">Автор: ${news.author}</span>
                    <span class="read-more" onclick="openNewsModal(${news.id})">Читать полностью</span>
                </div>
            `;
            
            return newsDiv;
        }

        // Фильтрация новостей
        function filterNewsByType(type) {
            currentFilter = type;
            renderNews();
        }

        function filterNewsByDate(range) {
            // В реальном приложении здесь была бы фильтрация по дате
            console.log('Фильтр по дате:', range);
            renderNews();
        }

        function searchNews(query) {
            // В реальном приложении здесь был бы поиск
            console.log('Поиск:', query);
            if (query) {
                const filtered = newsData.filter(news => 
                    news.title.toLowerCase().includes(query.toLowerCase()) ||
                    news.content.toLowerCase().includes(query.toLowerCase())
                );
                renderFilteredNews(filtered);
            } else {
                renderNews();
            }
        }

        function renderFilteredNews(filteredNews) {
            const newsGrid = document.getElementById('newsGrid');
            newsGrid.innerHTML = '';
            
            filteredNews.forEach(news => {
                const newsElement = createNewsElement(news);
                newsGrid.appendChild(newsElement);
            });
        }

        // Модальные окна
        function showCreateNewsModal() {
            document.getElementById('createNewsModal').classList.add('show');
        }

        function closeCreateNewsModal() {
            document.getElementById('createNewsModal').classList.remove('show');
            // Очистка формы
            document.getElementById('newsTitle').value = '';
            document.getElementById('newsContent').value = '';
        }

        function createNewNews() {
            const title = document.getElementById('newsTitle').value;
            const content = document.getElementById('newsContent').value;
            const category = document.getElementById('newsCategory').value;
            
            if (title && content) {
                const newNews = {
                    id: newsData.length + 1,
                    title: title,
                    preview: content.substring(0, 100) + '...',
                    content: content,
                    date: new Date().toLocaleDateString('ru-RU'),
                    category: category,
                    author: 'Иванов А.С.',
                    important: important,
                    attachments: []
                };
                
                newsData.unshift(newNews); // Добавляем в начало массива
                closeCreateNewsModal();
                renderNews();
            } else {
                alert('Пожалуйста, заполните заголовок и содержание новости');
            }
        }

        function openNewsModal(newsId) {
            const news = newsData.find(n => n.id === newsId);
            
            if (news) {
                document.getElementById('modalNewsTitle').textContent = news.title;
                document.getElementById('modalNewsDate').textContent = news.date;
                document.getElementById('modalNewsCategory').textContent = getCategoryText(news.category);
                document.getElementById('modalNewsAuthor').textContent = `Автор: ${news.author}`;
                document.getElementById('modalNewsContent').innerHTML = news.content;
                
                const attachmentsContainer = document.getElementById('modalNewsAttachments');
                if (news.attachments.length > 0) {
                    attachmentsContainer.innerHTML = `
                        <h3>Прикрепленные файлы:</h3>
                        ${news.attachments.map(att => 
                            `<a href="#" class="attachment">📎 ${att.name}</a>`
                        ).join('')}
                    `;
                } else {
                    attachmentsContainer.innerHTML = '';
                }
                
                document.getElementById('newsModal').classList.add('show');
            }
        }

        function closeNewsModal() {
            document.getElementById('newsModal').classList.remove('show');
        }

        function getCategoryText(category) {
            const texts = {
                'announcement': 'Объявление',
                'event': 'Событие',
                'medical': 'Медицинское',
                'technical': 'Техническое'
            };
            return texts[category];
        }

        // Функции для модального окна Telegram
        function showTelegramModal() {
            document.getElementById('telegramModal').classList.add('show');
            document.getElementById('dropdownMenu').classList.remove('show');
            resetTelegramForm();
        }

        function closeTelegramModal() {
            document.getElementById('telegramModal').classList.remove('show');
        }

        function resetTelegramForm() {
            document.getElementById('verificationCode').value = '';
            document.getElementById('codeError').style.display = 'none';
            document.getElementById('codeSuccess').style.display = 'none';
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('statusConnected').classList.remove('show');
            document.getElementById('connectionInfo').classList.add('hidden');
            document.getElementById('disconnectBtn').classList.add('hidden');
            document.getElementById('connectBtn').classList.remove('hidden');
        }

        function validateVerificationCode() {
            const code = document.getElementById('verificationCode').value.toUpperCase();
            const connectBtn = document.getElementById('connectBtn');
            
            // Проверка формата кода (6 символов, буквы и цифры)
            const isValid = /^[A-Z0-9]{6}$/.test(code);
            
            connectBtn.disabled = !isValid;
            
            if (code.length === 6 && !isValid) {
                document.getElementById('codeError').style.display = 'block';
                document.getElementById('codeSuccess').style.display = 'none';
            } else if (isValid) {
                document.getElementById('codeError').style.display = 'none';
                document.getElementById('codeSuccess').style.display = 'block';
            } else {
                document.getElementById('codeError').style.display = 'none';
                document.getElementById('codeSuccess').style.display = 'none';
            }
        }

        function connectTelegram() {
            const code = document.getElementById('verificationCode').value.toUpperCase();
            
            // В реальном приложении здесь был бы AJAX запрос к серверу
            console.log('Привязка Telegram с кодом:', code);
            
            // Демо-логика для презентации
            if (code === 'ABC123') {
                // Успешная привязка
                document.getElementById('statusConnected').classList.add('show');
                document.getElementById('connectionInfo').classList.remove('hidden');
                document.getElementById('connectBtn').classList.add('hidden');
                document.getElementById('disconnectBtn').classList.remove('hidden');
                
                // Блокируем поле ввода
                document.getElementById('verificationCode').disabled = true;
            } else {
                // Ошибка привязки
                document.getElementById('codeError').style.display = 'block';
                document.getElementById('codeError').textContent = 'Неверный код подтверждения';
            }
        }

        function disconnectTelegram() {
            // В реальном приложении здесь был бы AJAX запрос к серверу
            console.log('Отвязка Telegram');
            
            // Сброс формы
            resetTelegramForm();
            document.getElementById('verificationCode').disabled = false;
            
            // Показываем сообщение об успешной отвязке
            alert('Telegram успешно отвязан от вашего аккаунта');
        }

        // Функции для модального окна смены пароля
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('show');
            document.getElementById('dropdownMenu').classList.remove('show');
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('show');
            resetPasswordForm();
        }

        function resetPasswordForm() {
            document.getElementById('changePasswordForm').reset();
            document.getElementById('confirmPasswordError').style.display = 'none';
            document.getElementById('passwordSuccess').style.display = 'none';
            document.getElementById('savePasswordBtn').disabled = true;
        }

        function togglePasswordVisibility(fieldId) {
            const field = document.getElementById(fieldId);
            const button = field.parentNode.querySelector('.toggle-password');
            
            if (field.type === 'password') {
                field.type = 'text';
                button.textContent = '🔒';
            } else {
                field.type = 'password';
                button.textContent = '👁️';
            }
        }

        function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // В реальном приложении здесь был бы AJAX запрос к серверу
            console.log('Смена пароля:', {
                newPassword: newPassword,
                confirmPassword: confirmPassword
            });
            
            document.getElementById('passwordSuccess').style.display = 'block';
            document.getElementById('savePasswordBtn').disabled = true;
                
            setTimeout(() => {
                closeChangePasswordModal();
            }, 2000);
        }

        function validatePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const saveBtn = document.getElementById('savePasswordBtn');
            const passwordsMatch = newPassword === confirmPassword && newPassword !== '';

            // Показ ошибки подтверждения пароля
            document.getElementById('confirmPasswordError').style.display = 
                confirmPassword && !passwordsMatch ? 'block' : 'none';
            
            saveBtn.disabled = !(passwordsMatch);
        }

        // Закрытие модальных окон при клике вне их
        document.addEventListener('click', function(event) {
            const telegramModal = document.getElementById('telegramModal');
            const passwordModal = document.getElementById('changePasswordModal');
            
            if (event.target === telegramModal) {
                closeTelegramModal();
            }
            if (event.target === passwordModal) {
                closeChangePasswordModal();
            }
        });

        // Обработка Enter в форме
        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && document.getElementById('telegramModal').classList.contains('show')) {
                const connectBtn = document.getElementById('connectBtn');
                if (!connectBtn.disabled) {
                    connectTelegram();
                }
            }
        });
    </script>
</body>
</html>